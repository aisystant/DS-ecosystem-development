---
title: Концепция мета-модели цифрового двойника
type: doc
status: draft
created: 2026-02-01
updated: 2026-02-01
layer: methodology
scope: core-infrastructure
mcp_url: https://digital-twin-mcp.aisystant.workers.dev/mcp
repo_url: https://github.com/aisystant/digital-twin-mcp
audience:
  - "Команда экосистемы"
  - "Разработчики платформы"
  - "Методологи"
related_documents:
  - "C2.2.Architecture/3.2.3.1. Цифровой двойник/Модель данных цифрового двойника 3.2.md"
  - "C2.2.Architecture/3.2.3.1. Цифровой двойник/MCP-сервер цифрового двойника 3.2.md"
  - "Реестр мета-модели цифрового двойника.md"
---

# Концепция мета-модели цифрового двойника

> **Версия:** 0.3
> **MCP endpoint:** https://digital-twin-mcp.aisystant.workers.dev/mcp
> **Репозиторий:** https://github.com/aisystant/digital-twin-mcp

---

## 1. Назначение

### 1.1. Что такое мета-модель?

**Мета-модель** — это описание структуры данных цифрового двойника (`PRS.Twin`):
- Какие показатели существуют (коды, названия)
- Какие у них типы и форматы (float, enum, list)
- Пороги по ступеням Ученика
- Связи между показателями
- Правила использования в промптах

**Цифровой двойник** — это набор конкретных данных о человеке, соответствующий мета-модели.

```
Мета-модель (schema)              →    Данные (values)
────────────────────────────────────────────────────────
IND.2.1.1: float, часы/неделю     →    3.5 (для user_123)
IND.2.4.2: enum[5 ступеней]       →    "Систематический"
IND.1.5.1: list[pomodoro]         →    [{date, duration}, ...]
```

### 1.2. Зачем нужна мета-модель?

**Проблема:** Существующая [[Модель данных цифрового двойника 3.2]] описывает *какие* показатели есть, но не описывает:
- Машиночитаемые форматы для валидации
- Пороги по ступеням для автоматической квалификации
- Связи между показателями
- Правила использования в промптах

**Решение:** Мета-модель добавляет слой описаний поверх модели данных, доступный через единый MCP-сервер.

### 1.3. Согласование с репозиторием

| Аспект | Принятое решение |
|--------|------------------|
| **Нотация показателей** | `IND.1.*` (первичные), `IND.2.*` (производные), `IND.1.PREF.*` (настройки) |
| **Терминология** | `PRS.Twin`, `STG.Student.*`, `AGT.RouteGuide` |
| **Ступени Ученика** | Случайный → Практикующий → Систематический → Дисциплинированный → Проактивный |

### 1.4. Разделение первичных данных и мета-модели

**Первичные данные (IND.1.1 — IND.1.11)** — это сырые данные из ИТ-систем (LMS, клуб, боты). Их полный перечень описан в [[Модель данных цифрового двойника 3.2]].

**Мета-модель** фокусируется на:
- **Настройках (IND.1.PREF.*)** — настраиваемые предпочтения человека
- **Производных показателях (IND.2.*)** — вычисляемые из первичных данных
- **Порогах для квалификации** — критерии переходов между ступенями

Первичные данные не требуют порогов и форматов мета-модели — они задаются схемой БД и ETL-процессами.

---

## 2. Архитектура: единый MCP-сервер

### 2.1. Текущий статус

```
┌─────────────────────────────────────────────────────────────────┐
│  digital-twin-mcp                                                │
│  https://digital-twin-mcp.aisystant.workers.dev/mcp             │
├─────────────────────────────────────────────────────────────────┤
│  Cloudflare Workers + Durable Objects                           │
│                                                                  │
│  ┌────────────────────────────────────────────────────┐         │
│  │  MCP-сервер (единый)                               │         │
│  ├────────────────────────────────────────────────────┤         │
│  │                                                    │         │
│  │  Tools:                                            │         │
│  │  ├── describe_indicator      (мета-модель)        │         │
│  │  ├── list_indicators         (мета-модель)        │         │
│  │  ├── get_stage_thresholds    (мета-модель)        │         │
│  │  ├── validate_value          (мета-модель)        │         │
│  │  ├── read_indicator          (данные)             │         │
│  │  ├── write_indicator         (данные)             │         │
│  │  ├── get_learner_summary     (данные)             │         │
│  │  └── get_person_context      (данные)             │         │
│  │                                                    │         │
│  │  Текущее состояние:                               │         │
│  │  ├── [x] Базовая структура MCP                    │         │
│  │  ├── [ ] Авторизация ORY                          │         │
│  │  └── [ ] Реальная БД (заглушки)                   │         │
│  │                                                    │         │
│  └────────────────────────────────────────────────────┘         │
│                       │                                          │
│                       ▼                                          │
│  ┌────────────────────────────────────────────────────┐         │
│  │  Хранилище (TODO)                                  │         │
│  │  ├── SurrealDB / PostgreSQL                        │         │
│  │  └── Durable Objects (временно)                    │         │
│  └────────────────────────────────────────────────────┘         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2. Почему единый MCP, а не два?

**Ранее рассматривалось:** два MCP (META для схемы, DATA для данных).

**Принято решение:** единый MCP, потому что:
- Проще интеграция для клиентов (один endpoint)
- Инструменты мета-модели и данных связаны (validate_value проверяет по схеме)
- Cloudflare Workers хорошо масштабируется
- Меньше инфраструктурных компонентов

### 2.3. Источники данных

```
┌─────────────────────────────────────────────────────────────────┐
│                        MCP-сервер                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   Мета-модель (schema)            Данные участников              │
│   ──────────────────              ─────────────────              │
│                                                                  │
│   ┌─────────────────┐             ┌─────────────────┐           │
│   │ Hardcoded JSON  │             │ SurrealDB       │           │
│   │ в коде MCP      │             │ (или PostgreSQL)│           │
│   │                 │             │                 │           │
│   │ - stages        │             │ - persons/{}    │           │
│   │ - groups        │             │ - indicators/   │           │
│   │ - indicators    │             │ - history/      │           │
│   │ - thresholds    │             │                 │           │
│   └─────────────────┘             └─────────────────┘           │
│                                                                  │
│   Источник:                       Источник:                      │
│   Реестр мета-модели.md           API + ETL из LMS               │
│   (экспорт в JSON)                                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. MCP Tools

### 3.1. Инструменты мета-модели

#### `describe_indicator`

Возвращает полное описание показателя из мета-модели.

**Вход:**
```json
{
  "tool": "describe_indicator",
  "input": {"code": "IND.2.1.1"}
}
```

**Выход:**
```json
{
  "code": "IND.2.1.1",
  "name": "Среднее число часов саморазвития в неделю",
  "group": "2.1 Агентность и учебный ритм",
  "type": "temporal",
  "format": "float",
  "unit": "hours/week",
  "for_prompts": true,
  "for_qualification": true,
  "thresholds": {
    "STG.Student.Random": {"max": 0.5},
    "STG.Student.Practicing": {"min": 4},
    "STG.Student.Systematic": {"min": 6},
    "STG.Student.Disciplined": {"min": 8},
    "STG.Student.Proactive": {"min": 10}
  },
  "depends_on": ["IND.1.3.4", "IND.1.5.1"],
  "affects": ["IND.2.4.2", "IND.2.1.6"]
}
```

#### `list_indicators`

Возвращает список показателей по фильтру.

```json
// Вход
{"tool": "list_indicators", "input": {"group": "2.1", "for_qualification": true}}

// Выход
{
  "indicators": [
    {"code": "IND.2.1.1", "name": "Среднее число часов в неделю"},
    {"code": "IND.2.1.2", "name": "Доля дней со слотом"},
    {"code": "IND.2.1.6", "name": "Индекс регулярности"}
  ],
  "count": 3
}
```

#### `get_stage_thresholds`

Возвращает пороги показателей для конкретной ступени.

```json
// Вход
{"tool": "get_stage_thresholds", "input": {"stage": "STG.Student.Systematic"}}

// Выход
{
  "stage": "STG.Student.Systematic",
  "name": "Систематический",
  "period_weeks": 8,
  "thresholds": [
    {"code": "IND.2.1.1", "name": "Часы в неделю", "min": 6},
    {"code": "IND.2.1.2", "name": "Доля дней со слотом", "min": 0.71}
  ]
}
```

#### `validate_value`

Проверяет значение на соответствие формату и порогам.

```json
// Вход
{"tool": "validate_value", "input": {"code": "IND.2.1.1", "value": 5.5, "target_stage": "STG.Student.Systematic"}}

// Выход
{
  "valid": true,
  "format_ok": true,
  "threshold_check": {
    "target_stage": "STG.Student.Systematic",
    "required_min": 6,
    "meets_threshold": false,
    "gap": 0.5,
    "message": "Не хватает 0.5 часов для Систематического"
  }
}
```

### 3.2. Инструменты работы с данными

#### `read_indicator`

Читает значение показателя для человека.

```json
// Вход
{"tool": "read_indicator", "input": {"person_id": "user_123", "code": "IND.2.1.1", "period": "4_weeks"}}

// Выход
{
  "code": "IND.2.1.1",
  "value": 5.2,
  "unit": "hours/week",
  "stage_context": {"current_stage": "Практикующий", "threshold_for_next": 6, "gap": 0.8}
}
```

#### `write_indicator`

Записывает значение (для настраиваемых параметров).

```json
// Вход
{"tool": "write_indicator", "input": {"person_id": "user_123", "code": "IND.1.PREF.daily_task_time", "value": "08:30"}}

// Выход
{"success": true, "previous": "08:00", "new_value": "08:30"}
```

#### `get_person_context`

Возвращает полный контекст для промптов.

```json
// Вход
{"tool": "get_person_context", "input": {"person_id": "user_123"}}

// Выход
{
  "person_id": "user_123",
  "stage": {"current": "Практикующий", "next_target": "Систематический"},
  "metrics": {
    "IND.2.1.1": {"value": 5.2, "name": "Часы в неделю"},
    "IND.2.1.2": {"value": 0.57, "name": "Доля дней со слотом"}
  },
  "preferences": {"daily_task_time": "08:00", "role_set": ["менеджер", "отец"]},
  "stagnation_profile": "Тупик"
}
```

---

## 4. План работ

### Фаза 1: Внедрение мета-модели (текущая)

| Задача | Статус | Описание |
|--------|--------|----------|
| 1.1 | ✅ | MCP-сервер развёрнут на Cloudflare Workers |
| 1.2 | 🔄 | Добавить данные мета-модели в код MCP |
| 1.3 | ⏳ | Реализовать tools мета-модели (describe_indicator, list_indicators, get_stage_thresholds, validate_value) |
| 1.4 | ⏳ | Тестирование через Claude Desktop / MCP Inspector |

**Действия:**
1. Экспортировать JSON из [[Реестр мета-модели цифрового двойника.md]]
2. Добавить в https://github.com/aisystant/digital-twin-mcp
3. Реализовать tools мета-модели

### Фаза 2: Авторизация ORY

| Задача | Статус | Описание |
|--------|--------|----------|
| 2.1 | ⏳ | Интеграция с ORY (OIDC/OAuth2) |
| 2.2 | ⏳ | Middleware авторизации в MCP |
| 2.3 | ⏳ | Маппинг ORY user_id → person_id |

**Архитектура авторизации:**
```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Client     │────▶│    ORY      │────▶│  MCP-сервер │
│  (Bot/Web)  │     │  Kratos     │     │             │
└─────────────┘     └─────────────┘     └─────────────┘
       │                   │                   │
       │ 1. Login request  │                   │
       │──────────────────▶│                   │
       │                   │                   │
       │ 2. Redirect to    │                   │
       │    ORY login form │                   │
       │◀──────────────────│                   │
       │                   │                   │
       │ 3. User authenticates                 │
       │──────────────────▶│                   │
       │                   │                   │
       │ 4. Access token   │                   │
       │◀──────────────────│                   │
       │                   │                   │
       │ 5. MCP request + token                │
       │───────────────────────────────────────▶│
       │                   │                   │
       │                   │ 6. Validate token │
       │                   │◀──────────────────│
       │                   │                   │
       │ 7. Response                           │
       │◀───────────────────────────────────────│
```

### Фаза 3: Подключение БД

| Задача | Статус | Описание |
|--------|--------|----------|
| 3.1 | ⏳ | Развернуть SurrealDB (или PostgreSQL) |
| 3.2 | ⏳ | Схема данных для показателей |
| 3.3 | ⏳ | Реализовать tools данных (read_indicator, write_indicator, get_person_context) |
| 3.4 | ⏳ | ETL из LMS для первичных данных |

### Фаза 4: Интеграция с Telegram-ботом

| Задача | Статус | Описание |
|--------|--------|----------|
| 4.1 | ⏳ | Подключить MCP к тестовому боту |
| 4.2 | ⏳ | Тестирование tools через бота |
| 4.3 | ⏳ | Интеграция с Aist_bot (https://github.com/aisystant/aist_bot) |

**Интеграция Aist_bot + ORY:**
```
┌─────────────────────────────────────────────────────────────────┐
│  Telegram                                                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   Пользователь                                                   │
│        │                                                         │
│        │ 1. /start или первое сообщение                         │
│        ▼                                                         │
│   ┌─────────────┐                                                │
│   │  Aist_bot   │                                                │
│   └──────┬──────┘                                                │
│          │                                                       │
│          │ 2. Проверка: есть ли access_token?                   │
│          │                                                       │
│          │ Нет ────────────────────────────────┐                │
│          │                                     │                │
│          │ 3. Отправить ссылку на авторизацию │                │
│          │    (ORY login page в браузере)     │                │
│          ▼                                     │                │
│   ┌─────────────┐                              │                │
│   │  Браузер    │◀─────────────────────────────┘                │
│   │  ORY Form   │                                                │
│   └──────┬──────┘                                                │
│          │                                                       │
│          │ 4. Пользователь логинится                            │
│          │                                                       │
│          │ 5. ORY callback → бот получает token                 │
│          ▼                                                       │
│   ┌─────────────┐     ┌─────────────────┐                       │
│   │  Aist_bot   │────▶│  digital-twin   │                       │
│   │  + token    │     │  MCP-сервер     │                       │
│   └─────────────┘     └─────────────────┘                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Ветка разработки:** Андрей работает в отдельной ветке aist_bot.

---

## 5. Связь с существующими документами

### 5.1. Отношение к Модели данных цифрового двойника 3.2

| Аспект | Модель данных 3.2 | Мета-модель |
|--------|-------------------|-------------|
| **Что описывает** | Какие показатели существуют | Как описаны показатели |
| **Формат** | Таблицы с перечнем | JSON с деталями |
| **Пороги** | Упомянуты в тексте | Структурированы машиночитаемо |
| **Использование** | Понимание структуры | Валидация, автоматизация |

**Мета-модель НЕ заменяет, а дополняет** существующую модель данных.

### 5.2. Репозитории

| Репозиторий | Содержимое |
|-------------|------------|
| `aisystant/ecosystem-development` | Документация: Концепция, Реестр мета-модели |
| `aisystant/digital-twin-mcp` | Код MCP-сервера, JSON мета-модели |
| `aisystant/aist_bot` | Telegram-бот с интеграцией MCP |

---

## 6. Расширение мета-модели

### 6.1. Процесс добавления показателя

1. **Определить код** по нотации:
   - `IND.1.X.Y` — первичные данные
   - `IND.2.X.Y` — производные показатели
   - `IND.1.PREF.*` — настраиваемые предпочтения

2. **Добавить в реестр** [[Реестр мета-модели цифрового двойника.md]]

3. **Экспортировать JSON** и обновить https://github.com/aisystant/digital-twin-mcp

### 6.2. Версионирование

- **Мажорная версия:** изменение структуры групп, удаление показателей
- **Минорная версия:** добавление новых показателей
- **Патч:** уточнение описаний, исправление ошибок

---

## См. также

- [[Реестр мета-модели цифрового двойника.md]] — реестр показателей
- [[C2.2.Architecture/3.2.3.1. Цифровой двойник/Модель данных цифрового двойника 3.2.md]] — базовая модель данных
- [[C2.2.Architecture/3.2.3.1. Цифровой двойник/MCP-сервер цифрового двойника 3.2.md]] — существующий MCP-сервер
- https://github.com/aisystant/digital-twin-mcp — репозиторий MCP-сервера
- https://github.com/aisystant/aist_bot — Telegram-бот
