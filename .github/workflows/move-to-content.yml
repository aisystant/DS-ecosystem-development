name: move-to-content
on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  move:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup git identity (bot)
        run: |
          git config user.name "chatgpt-bot"
          git config user.email "chatgpt-bot@users.noreply.github.com"
          git config core.quotepath false

      - name: Create branch
        id: branch
        run: |
          BRANCH="chore/move-content-$(date +%s)"
          git checkout -b "$BRANCH"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Ensure target root exists
        run: mkdir -p content

      - name: Debug: list root entries
        run: ls -la

      - name: Move top-level sections 0–4 into content/ (robust)
        shell: bash
        run: |
          set -e
          mkdir -p content
          moved=0
          # перебираем ТОЛЬКО каталоги верхнего уровня
          while IFS= read -r entry; do
            # совпадает с "0. ...", "1. ...", ..., "4. ..."
            if [[ "$entry" =~ ^[0-4]\.\  ]]; then
              if [ -d "$entry" ]; then
                echo "Moving dir: $entry -> content/"
                git mv -k "$entry" "content/" || true
                moved=1
              fi
            fi
          done < <(ls -1)

          echo "---- git status ----"
          git status --porcelain || true

          # если перенос не отработал по каким-то причинам, выйдем мягко
          if ! git status --porcelain | grep -q . ; then
            echo "Nothing to move"
            exit 0
          fi

          git add -A
          git commit -m "refactor(content): move sections 0–4 into content/"

      - name: Push branch
        run: |
          BRANCH="${{ steps.branch.outputs.branch }}"
          git push -u origin "$BRANCH"

      - name: Create Pull Request (gh cli)
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          BRANCH="${{ steps.branch.outputs.branch }}"
          # устанавливаем gh (на ubuntu-latest уже есть)
          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "refactor(content): move sections 0–4 into content/" \
            --body  "Automated move via workflow. After merge, run repo-inventory to refresh artifacts/inventories/repo_inventory.tsv." \
          || echo "No changes or PR already exists"
