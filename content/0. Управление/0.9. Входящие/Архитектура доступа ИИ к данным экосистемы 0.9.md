---
type: architecture
status: draft
version: 1.0
created: 2025-12-29
updated: 2025-12-30
layer: platform
scope: ecosystem
description: "Архитектура доступа ИИ-ассистентов к данным экосистемы"
related:
  - "FSM-архитектура ИИ-ассистентов 3.2"
  - "Интеграция ассистентов через OpenAI Apps SDK 0.9"
  - "Канонический шаблон описания MCP Tools и Resources"
---

# Архитектура доступа ИИ к данным экосистемы

## Назначение документа

Документ описывает архитектуру системы, которая позволяет:

1. **Пользователям** — получать персонализированные рекомендации через разные интерфейсы (ChatGPT, Telegram, Web)
2. **ИИ-ассистентам** — безопасно получать данные пользователей для формирования рекомендаций
3. **Разработчикам** — создавать новых ИИ-ассистентов с доступом к данным экосистемы

---

## Ключевые принципы

| Принцип | Реализация |
|---------|------------|
| **Разделение логики и данных** | MCP с логикой (fsm-mcp) отдельно от MCP с доступом к БД (dt-mcp) |
| **Приватность по умолчанию** | Агент получает только те данные, которые нужны для текущего сценария |
| **Один интерфейс — много ассистентов** | Через ChatGPT/Telegram можно подключить разных ассистентов |
| **Server-to-server для данных** | fsm-mcp вызывает dt-mcp напрямую, не через LLM |

---

## Схема архитектуры

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              ПОЛЬЗОВАТЕЛИ                                   │
│                                                                             │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐                   │
│  │ Вася          │  │ Петя          │  │ Маша          │                   │
│  │ (ученик МИМ)  │  │ (ученик МИМ)  │  │ (ученик МИМ)  │                   │
│  └───────────────┘  └───────────────┘  └───────────────┘                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ взаимодействует через
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              ИНТЕРФЕЙСЫ                                     │
│                                                                             │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐               │
│  │ ChatGPT         │ │ Telegram Bot    │ │ Web App         │               │
│  │ (Apps SDK)      │ │                 │ │                 │               │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘               │
│                                                                             │
│  Интерфейсы — только UI. Не хранят данные, не исполняют логику.            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ запросы пользователей
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                                 LLM                                         │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ GPT (OpenAI) / Claude (Anthropic) / другие                          │   │
│  │                                                                     │   │
│  │ • Понимает запрос пользователя                                     │   │
│  │ • Вызывает MCP-инструменты                                         │   │
│  │ • Формирует ответ                                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ вызов get_instruction()
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        MCP С ЛОГИКОЙ (FSM)                                  │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ fsm-mcp (Cloudflare Workers)                                        │   │
│  │                                                                     │   │
│  │ ИИ-ассистенты:                                                      │   │
│  │ ┌─────────────────────────────────────────────────────────────┐    │   │
│  │ │ • Проводник по персональному маршруту развития              │    │   │
│  │ │   (Ассистент Ученика)                                        │    │   │
│  │ │ • ... (другие ассистенты в будущем)                          │    │   │
│  │ └─────────────────────────────────────────────────────────────┘    │   │
│  │                                                                     │   │
│  │ Инструменты:                                                        │   │
│  │ • get_instruction(state?) — получить инструкции состояния          │   │
│  │                                                                     │   │
│  │ Внутри:                                                             │   │
│  │ • states/*.md — FSM-логика в markdown                              │   │
│  │ • Вызовы к MCP с доступом к БД (server-to-server)                  │   │
│  │                                                                     │   │
│  │ Кто создаёт: Разработчики ИИ-ассистентов                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ server-to-server вызовы
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      MCP С ДОСТУПОМ К БАЗАМ ДАННЫХ                          │
│                                                                             │
│  ┌────────────────────┐ ┌────────────────────┐ ┌────────────────────┐      │
│  │ dt-mcp             │ │ guides-mcp         │ │ exercises-mcp      │      │
│  │ (Цифровой двойник) │ │ (Руководства)      │ │ (Упражнения)       │      │
│  │                    │ │                    │ │                    │      │
│  │ • dt.get_progress  │ │ • guides.search    │ │ • exercises.get    │      │
│  │ • dt.get_goals     │ │ • guides.get       │ │ • exercises.check  │      │
│  │ • dt.save_*        │ │                    │ │                    │      │
│  └─────────┬──────────┘ └─────────┬──────────┘ └─────────┬──────────┘      │
│            │                      │                      │                  │
│  Кто создаёт: Архитектор ИИ-платформы                                      │
│                                                                             │
└────────────┼──────────────────────┼──────────────────────┼──────────────────┘
             │                      │                      │
             ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           БАЗЫ ДАННЫХ                                       │
│                                                                             │
│  ┌────────────────────┐ ┌────────────────────┐ ┌────────────────────┐      │
│  │ Digital Twin Store │ │ Guides Repository  │ │ Exercises Bank     │      │
│  │ (SurrealDB)        │ │ (Git + SurrealDB)  │ │ (SurrealDB + S3)   │      │
│  │                    │ │                    │ │                    │      │
│  │ • Прогресс         │ │ • Руководства      │ │ • Упражнения       │      │
│  │ • Цели             │ │ • Шаблоны          │ │ • Рубрики          │      │
│  │ • Метрики          │ │                    │ │                    │      │
│  └────────────────────┘ └────────────────────┘ └────────────────────┘      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Два типа MCP-серверов

### MCP с логикой (fsm-mcp)

| Характеристика | Описание |
|----------------|----------|
| **Назначение** | Оркестрация диалога, FSM-переходы между состояниями |
| **Инструменты** | `get_instruction(state?)` |
| **Содержимое** | `states/*.md` — инструкции для каждого состояния |
| **Вызывает** | MCP с доступом к БД (server-to-server) |
| **Кто создаёт** | Разработчики ИИ-ассистентов |
| **Размещение** | Cloudflare Workers |

### MCP с доступом к БД

| Характеристика | Описание |
|----------------|----------|
| **Назначение** | Чтение/запись данных в хранилища |
| **Инструменты** | `dt.get_progress()`, `guides.search()`, и т.д. |
| **Содержимое** | Логика доступа к базам данных |
| **Вызывается** | Из fsm-mcp (не напрямую от LLM) |
| **Кто создаёт** | Архитектор ИИ-платформы |
| **Размещение** | Cloudflare Workers |

---

## Взаимодействие компонентов

### Полный поток запроса

```
1. ПОЛЬЗОВАТЕЛЬ
   Вася пишет в ChatGPT: "Подведи итоги недели"
                │
                ▼
2. ИНТЕРФЕЙС (ChatGPT)
   Передаёт запрос в GPT с подключённым MCP
                │
                ▼
3. LLM (GPT)
   Понимает намерение, вызывает: get_instruction()
                │
                ▼
4. fsm-mcp
   • Определяет состояние: weekly_reflection
   • Читает инструкции из states/weekly_reflection.md
   • Инструкции требуют данные → вызывает dt-mcp
                │
                │  fetch("https://dt-mcp.../mcp")
                │  { tool: "dt.get_week_summary", args: {user_id} }
                ▼
5. dt-mcp
   • Проверяет токен авторизации
   • Запрашивает данные из SurrealDB
   • Возвращает: { pomodoros: 12, achievements: [...] }
                │
                ▼
6. fsm-mcp
   • Получает данные
   • Возвращает инструкции + контекст с данными
                │
                ▼
7. LLM (GPT)
   Формирует персонализированный ответ по инструкциям
                │
                ▼
8. ИНТЕРФЕЙС (ChatGPT)
   Показывает ответ пользователю
```

### Диаграмма вызовов

```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│  ChatGPT    │      │    GPT      │      │  fsm-mcp    │      │   dt-mcp    │
└──────┬──────┘      └──────┬──────┘      └──────┬──────┘      └──────┬──────┘
       │                    │                    │                    │
       │  "итоги недели"    │                    │                    │
       │───────────────────>│                    │                    │
       │                    │                    │                    │
       │                    │  get_instruction() │                    │
       │                    │───────────────────>│                    │
       │                    │                    │                    │
       │                    │                    │ dt.get_week_summary│
       │                    │                    │───────────────────>│
       │                    │                    │                    │
       │                    │                    │    { data: ... }   │
       │                    │                    │<───────────────────│
       │                    │                    │                    │
       │                    │  { instructions,   │                    │
       │                    │    context: data } │                    │
       │                    │<───────────────────│                    │
       │                    │                    │                    │
       │   "На этой неделе  │                    │                    │
       │    вы сделали..."  │                    │                    │
       │<───────────────────│                    │                    │
       │                    │                    │                    │
```

---

## Авторизация

### Поток авторизации

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  1. Пользователь входит через интерфейс (ChatGPT / Telegram / Web)         │
│                                                                             │
│  2. OAuth авторизация через Aisystant Identity                             │
│     • Пользователь логинится                                               │
│     • Получает access_token                                                │
│                                                                             │
│  3. Токен передаётся в MCP-запросы                                         │
│     • Интерфейс → fsm-mcp (Authorization: Bearer <token>)                  │
│     • fsm-mcp → dt-mcp (Authorization: Bearer <token>)                     │
│                                                                             │
│  4. dt-mcp проверяет токен                                                 │
│     • Валидность токена                                                    │
│     • Извлекает user_id                                                    │
│     • Возвращает только данные этого пользователя                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Передача токена между MCP

```typescript
// fsm-mcp: получает токен от интерфейса, передаёт в dt-mcp

async function callDtMcp(tool: string, args: object, token: string) {
  const response = await fetch('https://dt-mcp.aisystant.workers.dev/mcp', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`  // передаём токен дальше
    },
    body: JSON.stringify({ tool, args })
  });

  return response.json();
}
```

---

## Подключение через OpenAI Apps SDK

### Как это работает

OpenAI Apps SDK позволяет создать App в ChatGPT, который подключает MCP-серверы. Пользователи ChatGPT могут использовать этот App для взаимодействия с ИИ-ассистентом.

### Архитектура подключения

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  ChatGPT                                                                    │
│     │                                                                       │
│     │  Apps SDK подключает MCP                                             │
│     │                                                                       │
│     ▼                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ fsm-mcp.aisystant.workers.dev/mcp                                   │   │
│  │                                                                     │   │
│  │ Единственный MCP, видимый для ChatGPT                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│     │                                                                       │
│     │  server-to-server (скрыто от ChatGPT)                               │
│     ▼                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ dt-mcp, guides-mcp, exercises-mcp                                   │   │
│  │                                                                     │   │
│  │ Внутренние MCP, ChatGPT их не видит                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Важные моменты

| Аспект | Решение |
|--------|---------|
| **Сколько MCP в Apps SDK** | Один — fsm-mcp |
| **Как dt-mcp получает запросы** | Через fsm-mcp (server-to-server) |
| **Авторизация** | OAuth через Aisystant Identity |
| **Токен** | Передаётся от Apps SDK → fsm-mcp → dt-mcp |

### Связь с документом

Подробнее см. **[[Интеграция ассистентов через OpenAI Apps SDK 0.9]]**

---

## Таблица компонентов

| Компонент | Тип | Размещение | Технологии |
|-----------|-----|------------|------------|
| **ChatGPT App** | Интерфейс | OpenAI | Apps SDK |
| **Telegram Bot** | Интерфейс | Сервер МИМ | Node.js / Python |
| **Web App** | Интерфейс | Vercel / CF Pages | React |
| **fsm-mcp** | MCP с логикой | Cloudflare Workers | TypeScript |
| **dt-mcp** | MCP с доступом | Cloudflare Workers | TypeScript |
| **guides-mcp** | MCP с доступом | Cloudflare Workers | TypeScript |
| **exercises-mcp** | MCP с доступом | Cloudflare Workers | TypeScript |
| **Identity Provider** | Авторизация | Сервер МИМ | Keycloak / Custom |
| **Digital Twin Store** | База данных | Cloud | SurrealDB |
| **Guides Repository** | База данных | Cloud | Git + SurrealDB |
| **Exercises Bank** | База данных | Cloud | SurrealDB + S3 |

---

## ИИ-ассистенты

### Текущий ассистент

| Название | Описание | MCP |
|----------|----------|-----|
| **Проводник по персональному маршруту развития** (Ассистент Ученика) | Помогает планировать обучение, подводить итоги, работать с затыками | fsm-mcp |

### Добавление новых ассистентов

Новые ассистенты создаются как:
1. Новые `states/*.md` в fsm-mcp (если используют ту же логику)
2. Отдельный MCP с логикой (если логика существенно отличается)

Все ассистенты используют общие MCP с доступом к БД (dt-mcp, guides-mcp).

---

## Связь с FSM-архитектурой

Этот документ **дополняет** принятую [[FSM-архитектура ИИ-ассистентов 3.2]]:

| FSM-архитектура | Этот документ |
|-----------------|---------------|
| Как организовать логику диалога | Как получить данные для диалога |
| `states/*.md`, `get_instruction()` | `dt-mcp`, `guides-mcp` |
| Один MCP (fsm-mcp) | Два типа MCP (логика + данные) |
| Работает | Расширяет |

**fsm-mcp** из FSM-архитектуры теперь вызывает **dt-mcp** для получения данных пользователя.

---

## Связанные документы

- **[[FSM-архитектура ИИ-ассистентов 3.2]]** — архитектура FSM-логики ассистентов
- **[[Интеграция ассистентов через OpenAI Apps SDK 0.9]]** — подключение через ChatGPT
- **[[Канонический шаблон описания MCP Tools и Resources]]** — формат описания инструментов

---

## Changelog

| Дата | Версия | Изменения |
|------|--------|-----------|
| 2025-12-29 | v0.1–v0.6 | Разработка концепции |
| 2025-12-30 | v1.0 | Упрощение: убраны Gateway, агенты сообщества, Policy Engine. Фокус на реальной архитектуре |
