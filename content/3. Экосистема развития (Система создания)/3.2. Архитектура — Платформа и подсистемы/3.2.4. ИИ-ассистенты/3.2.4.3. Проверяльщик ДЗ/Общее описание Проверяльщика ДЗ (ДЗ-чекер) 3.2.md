# ДЗ-чекер: ИИ-проверка домашних заданий

Система автоматической проверки домашних заданий студентов с использованием LLM и репозитория руководств.

## Назначение

ДЗ-чекер — это ИИ-агент, который:
- Принимает ответы студентов из LMS по заданиям типа «чеклист/дз»
- Сопоставляет их с нормативными материалами из **репозитория руководств**
- Оценивает по заданным критериям (рубрикам) с помощью LLM
- Возвращает структурированную обратную связь студенту

**Источник нормативных материалов:** [Репозиторий руководств](../../../0.%20Управление/0.9.%20Входящие/Структура%20репозитория%20руководств%200.9.md) — хранилище текстов руководств образовательных программ ШСМ.

---

## Системы и их взаимодействие

```
                                              ┌────────────────┐
                                              │                │
                                              │  Репозиторий   │
                                              │  руководств    │
                                              └────────────────┘
                                                 ▲          │
                                            [A3] │          │ [A4]
                                                 │          ▼
┌────────────────┐  [A1]  ┌────────────────┐  [A2]  ┌────────────────┐  [A5]  ┌────────────────┐
│                │        │                │        │                │        │                │
│    Студент     │ ─────▶ │      LMS       │ ─────▶ │   ДЗ-чекер     │ ─────▶ │      LLM       │
│                │        │                │        │                │        │                │
│                │ ◀───── │                │ ◀───── │                │ ◀───── │                │
│                │  [A8]  │                │  [A7]  │                │  [A6]  │                │
└────────────────┘        └────────────────┘        └────────────────┘        └────────────────┘
```

### Роли систем

| Система | Роль | Данные |
|---------|------|--------|
| **Студент** | Источник ответа | Текст ответа на пункт чеклиста/ДЗ |
| **LMS (Aisystant)** | Хранилище и интерфейс | Вопросы, ответы, метаданные, результаты |
| **ДЗ-чекер** | Движок проверки | Логика сборки контекста и запросов |
| **Репозиторий руководств** | Источник норматива | Тексты руководств, рубрики, карта вопросов |
| **LLM** | Исполнитель проверки | Сопоставление ответа с критериями |

---

## Артефакты (пакеты), которые "текут" по процессу

| № | Артефакт | Откуда → Куда | Описание |
|---|----------|---------------|----------|
| A1 | Ответ студента | Студент → LMS | Текст ответа + действие «Проверить с ИИ» |
| A2 | Пакет на проверку | LMS → ДЗ-чекер | Ответ + вопрос + метаданные |
| A3 | Запрос контекста | ДЗ-чекер → Репозиторий | Идентификатор вопроса для поиска норматива |
| A4 | Контекст проверки | Репозиторий → ДЗ-чекер | Норматив (фрагмент руководства) + рубрика |
| A5 | Запрос к LLM | ДЗ-чекер → LLM | Промпт с ответом, нормативом и критериями |
| A6 | Результат проверки | LLM → ДЗ-чекер | Вердикт, баллы, замечания, рекомендации |
| A7 | Пакет результата | ДЗ-чекер → LMS | Форматированный комментарий для отображения |
| A8 | Отображение результата | LMS → Студент | Комментарий ИИ-проверки в интерфейсе |

---

## Процесс проверки по шагам

### Шаг 1. Студент инициирует проверку в LMS

**Вход:**
- Текст ответа, набранный студентом в поле комментария к пункту чеклиста/ДЗ

**Действие (студент в интерфейсе LMS):**
- Ввод текста ответа в поле комментария
- Нажатие кнопки «Проверить с ИИ»

**Выход → LMS (артефакт A1: Ответ студента):**
- Текст ответа
- Идентификатор студента
- Идентификатор пункта чеклиста/ДЗ
- Время отправки

---

### Шаг 2. LMS отправляет пакет на проверку

**Вход:**
- Артефакт A1 (ответ студента)
- Данные пункта из банка заданий LMS

**Действие (внутри LMS):**
- Извлечение текста вопроса/пункта
- Добавление метаданных (курс, раздел)
- Формирование пакета на проверку

**Выход → ДЗ-чекер (артефакт A2: Пакет на проверку):**
- Текст ответа студента по выбранному пункту
- Текст вопроса/пункта
- Информация о разделе (текст из дерева навигации)
- Информация о курсе (текстовое название)

---

### Шаг 3. ДЗ-чекер запрашивает контекст из репозитория руководств

**Вход:**
- Артефакт A2 (пакет на проверку) — информация о курсе и разделе

**Действие (внутри ДЗ-чекера):**
- Валидация входящего пакета
- Поиск соответствующего руководства в репозитории по названию курса
- Формирование запроса к репозиторию руководств

**Выход → Репозиторий (артефакт A3: Запрос контекста):**
- Название курса
- Текст раздела из навигации

---

### Шаг 4. Репозиторий руководств возвращает контекст проверки

**Вход:**
- Артефакт A3 (запрос контекста)

**Действие (внутри репозитория руководств):**
- Поиск руководства по названию курса
- Определение раздела по тексту навигации
- Загрузка фрагмента текста руководства (норматив)
- Загрузка рубрики проверки (критерии с весами)

**Выход → ДЗ-чекер (артефакт A4: Контекст проверки):**
- Путь к разделу руководства
- Название раздела
- Текст норматива (фрагмент руководства)
- Рубрика проверки:
  - Название рубрики
  - Список критериев (идентификатор, вес, описание)
- Версия материалов

---

### Шаг 5. ДЗ-чекер отправляет запрос в LLM

**Вход:**
- Артефакт A2 (пакет на проверку) — вопрос и ответ
- Артефакт A4 (контекст проверки) — норматив и рубрика

**Действие (внутри ДЗ-чекера):**
- Загрузка системного промпта (роль наставника)
- Загрузка шаблона проверки
- Подстановка данных: вопрос, ответ, норматив, критерии
- Формирование запроса к API

**Выход → LLM (артефакт A5: Запрос к LLM):**
- Системный промпт (роль и принципы проверки)
- Текст вопроса
- Текст ответа студента
- Текст норматива
- Список критериев оценки
- Требования к формату ответа

---

### Шаг 6. LLM возвращает результат проверки

**Вход:**
- Артефакт A5 (запрос к LLM)

**Действие (внутри LLM):**
- Анализ ответа студента
- Сопоставление с нормативом
- Оценка по каждому критерию рубрики
- Формирование структурированного ответа

**Выход → ДЗ-чекер (артефакт A6: Результат проверки):**
- Вердикт (принято / на доработку / не принято)
- Общий балл (0–100)
- Сильные стороны ответа (список)
- Замечания (список):
  - Критерий
  - Что не так
  - Как исправить
- Рекомендация следующего шага
- Баллы по отдельным критериям

---

### Шаг 7. ДЗ-чекер возвращает результат в LMS (синхронно)

**Вход:**
- Артефакт A6 (результат проверки) от LLM
- Артефакт A2 (пакет на проверку)

**Действие (внутри ДЗ-чекера):**
- Проверка полноты результата
- Форматирование в читаемый вид (Markdown)

**Выход → LMS (артефакт A7: Пакет результата):**
- Текст комментария (форматированный)
- Время проверки

---

### Шаг 8. LMS показывает результат студенту

**Вход:**
- Артефакт A7 (пакет результата) от ДЗ-чекера

**Действие (внутри LMS):**
- Отображение текста результата в интерфейсе

**Выход → Студент (артефакт A8: Отображение результата):**
- Студент видит комментарий ИИ-проверки в интерфейсе LMS

> **Примечание v0.1:** Результат проверки нигде не сохраняется и потеряется при обновлении страницы или переходе на другие разделы курса.

---

## Концепции основных систем

### ДЗ-чекер: архитектура и модули

ДЗ-чекер — это микросервис-оркестратор, который координирует проверку домашних заданий. Он не содержит логики оценивания — её выполняет LLM.

**Варианты реализации (от простого к сложному):**

| Вариант | Платформа | Плюсы | Минусы |
|---------|-----------|-------|--------|
| **A. n8n workflow** | n8n (self-hosted или cloud) | Low-code, быстрое прототипирование, визуальная отладка | Ограниченная гибкость, зависимость от n8n |
| **B. Python-сервис** | FastAPI + Docker | Полный контроль, легко тестировать | Требует разработки |
| **C. Serverless** | AWS Lambda / Yandex Cloud Functions | Масштабируемость, оплата за вызовы | Холодный старт, сложнее отладка |

**Рекомендуемый вариант для v0.1:** Python-сервис на FastAPI в Docker-контейнере.

#### Модули ДЗ-чекера

```
┌────────────────────────────────────────────────────────────────┐
│                        ДЗ-чекер                                │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐ │
│  │   HTTP API   │  │  Валидатор   │  │   Конструктор        │ │
│  │   (FastAPI)  │──│   запросов   │──│   промптов           │ │
│  └──────────────┘  └──────────────┘  └──────────────────────┘ │
│         │                                       │              │
│         │                                       ▼              │
│         │              ┌──────────────────────────────────┐   │
│         │              │      LLM-коннектор               │   │
│         │              │  ┌─────────────────────────────┐ │   │
│         │              │  │ Claude API (основной)       │ │   │
│         │              │  │ claude-3-5-sonnet-20241022  │ │   │
│         │              │  └─────────────────────────────┘ │   │
│         │              │  ┌─────────────────────────────┐ │   │
│         │              │  │ Fallback: OpenAI GPT-4o     │ │   │
│         │              │  └─────────────────────────────┘ │   │
│         │              └──────────────────────────────────┘   │
│         │                            │                        │
│         ▼                            ▼                        │
│  ┌──────────────┐           ┌──────────────┐                 │
│  │  Коннектор   │           │  Форматтер   │                 │
│  │  репозитория │           │  результата  │                 │
│  │  руководств  │           │  (Markdown)  │                 │
│  └──────────────┘           └──────────────┘                 │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

**Описание модулей:**

| Модуль | Ответственность | Технология |
|--------|-----------------|------------|
| **HTTP API** | Приём запросов от LMS, возврат результатов | FastAPI |
| **Валидатор запросов** | Проверка структуры входящих данных | Pydantic |
| **Конструктор промптов** | Сборка промпта из шаблона, норматива, критериев | Jinja2 |
| **LLM-коннектор** | Взаимодействие с Claude API и fallback-моделями | anthropic SDK |
| **Коннектор репозитория** | Получение норматива из репозитория руководств | HTTP/MCP client |
| **Форматтер результата** | Преобразование ответа LLM в читаемый формат | Markdown |

#### Выбор LLM

**Основная модель:** Claude 3.5 Sonnet (`claude-3-5-sonnet-20241022`)
- Оптимальный баланс качества и стоимости для задач проверки
- Хорошее понимание контекста и рубрик
- API доступен через Anthropic Console

**Размещение LLM:** Внешний сервис Anthropic (https://api.anthropic.com)
- Доступ по API-ключу
- Не требует собственной инфраструктуры для GPU

**Fallback-модели (v0.3):**
- OpenAI GPT-4o — при недоступности Claude API
- Gemini 1.5 Pro — альтернативный fallback

---

### Репозиторий руководств: архитектура

Репозиторий руководств — это **git-репозиторий с markdown-файлами** плюс **MCP-сервер** для предоставления контекста.

```
┌────────────────────────────────────────────────────────────────┐
│                   Репозиторий руководств                       │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │              Git-репозиторий (GitHub)                    │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │ │
│  │  │ guides/     │  │ rubrics/    │  │ mappings/   │      │ │
│  │  │ *.md        │  │ *.yaml      │  │ *.yaml      │      │ │
│  │  │ (тексты     │  │ (рубрики    │  │ (карта      │      │ │
│  │  │ руководств) │  │ проверки)   │  │ вопросов)   │      │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘      │ │
│  └──────────────────────────────────────────────────────────┘ │
│                              │                                 │
│                              ▼                                 │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │                    MCP-сервер                            │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │  Эндпоинт: /check-context                           │ │ │
│  │  │  Вход: {course_name, section_title}                 │ │ │
│  │  │  Выход: {normative_text, rubric, section_path}      │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  │                                                          │ │
│  │  Функции:                                                │ │
│  │  • Поиск руководства по названию курса                  │ │
│  │  • Извлечение раздела по заголовку                      │ │
│  │  • Подбор рубрики по типу задания                       │ │
│  │  • Кэширование для ускорения                            │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

**Структура git-репозитория:**

```
guides-repository/
├── guides/                        # Тексты руководств
│   ├── systems-thinking/          # По курсам
│   │   ├── chapter-01.md
│   │   ├── chapter-02.md
│   │   └── ...
│   └── modeling/
│       └── ...
├── rubrics/                       # Рубрики проверки
│   ├── concept-understanding.yaml # Понимание концепции
│   ├── deep-understanding.yaml    # Глубокое понимание
│   └── practical-application.yaml # Практическое применение
├── mappings/                      # Карты соответствий
│   ├── courses.yaml               # Курс → путь к руководству
│   └── questions.yaml             # Вопрос → раздел + рубрика
├── mcp-server/                    # MCP-сервер
│   ├── server.py
│   ├── config.yaml
│   └── Dockerfile
└── README.md
```

**MCP (Model Context Protocol):**
- Стандартный протокол для предоставления контекста LLM-агентам
- Позволяет ДЗ-чекеру запрашивать нужные фрагменты руководств
- Поддерживается Claude и другими современными LLM

---

### Инфраструктура развёртывания

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Инфраструктура                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────┐      ┌─────────────┐      ┌─────────────────┐    │
│   │    LMS      │      │  ДЗ-чекер   │      │   Репозиторий   │    │
│   │  (Aisystant)│─────▶│  (Docker)   │─────▶│   руководств    │    │
│   │             │      │             │      │   (MCP-сервер)  │    │
│   └─────────────┘      └──────┬──────┘      └─────────────────┘    │
│                               │                                     │
│                               ▼                                     │
│                        ┌─────────────┐                             │
│                        │ Claude API  │                             │
│                        │ (Anthropic) │                             │
│                        └─────────────┘                             │
│                                                                     │
│   Хостинг вариантов:                                               │
│   • VPS (Selectel, Timeweb) — для начала                           │
│   • Kubernetes — для масштабирования                               │
│   • Yandex Cloud / AWS — для serverless                            │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Что нужно сделать по каждой системе

### LMS (Aisystant)

| Задача | Приоритет | Описание |
|--------|-----------|----------|
| **Кнопка «Проверить с ИИ»** | v0.1 | Кнопка для пунктов чеклиста/ДЗ |
| **Проверка подписки БР** | v0.1 | Доступ только для пользователей с подпиской БР |
| **Вызов endpoint ДЗ-чекера** | v0.1 | Синхронный POST-запрос с данными |
| **Отображение результата** | v0.1 | Показ текста проверки (без сохранения) |
| **Сохранение результатов** | v0.2 | Запись результатов в БД |
| **Статусы проверки** | v0.2 | Отображение: «На проверке ИИ», «Проверено ИИ» |

### ДЗ-чекер

| Задача | Приоритет | Описание |
|--------|-----------|----------|
| **HTTP-endpoint** | v0.1 | Синхронный endpoint для приёма запросов от LMS (FastAPI) |
| **Валидатор запросов** | v0.1 | Pydantic-схемы для проверки входящих/исходящих данных |
| **Конструктор промптов** | v0.1 | Jinja2-шаблоны для сборки промптов с нормативом и критериями |
| **LLM-коннектор** | v0.1 | Модуль взаимодействия с Claude API (anthropic SDK) |
| **Коннектор репозитория** | v0.1 | HTTP/MCP-клиент для получения норматива по названию курса/раздела |
| **Форматтер результата** | v0.1 | Преобразование ответа LLM в Markdown для отображения |
| **Dockerfile** | v0.1 | Контейнеризация сервиса для развёртывания |
| **Конфигурация** | v0.1 | config.yaml с настройками API-ключей, URL, таймаутов |
| **Карта вопросов** | v0.2 | Связь идентификаторов вопросов с руководствами |
| **Рубрики проверки** | v0.2 | Критерии с весами для разных типов вопросов |
| **Очередь задач** | v0.2 | Асинхронная обработка для пакетных проверок |
| **Логирование** | v0.2 | Журнал проверок для аудита и отладки |
| **Fallback-логика** | v0.3 | Переключение на GPT-4o/Gemini при недоступности Claude |

### Репозиторий руководств

| Задача | Приоритет | Описание |
|--------|-----------|----------|
| **Git-репозиторий** | v0.1 | Создание репозитория с структурой guides/, rubrics/, mappings/ |
| **Структура руководств** | v0.1 | Организация markdown-файлов по курсам с чёткими разделами |
| **MCP-сервер** | v0.1 | Python-сервер с эндпоинтом /check-context |
| **Базовые рубрики** | v0.1 | YAML-файлы с критериями: понимание концепции, глубокое понимание |
| **Карта courses.yaml** | v0.1 | Соответствие название курса → путь к руководству |
| **Dockerfile для MCP** | v0.1 | Контейнеризация MCP-сервера |
| **Наполнение карты вопросов** | v0.2 | Связать все вопросы ДЗ с разделами руководств |
| **Версионирование** | v0.2 | Git-теги для отслеживания версий материалов |
| **Кэширование** | v0.2 | Redis/in-memory кэш для ускорения запросов |

### LLM (Внешний сервис)

| Задача | Приоритет | Описание |
|--------|-----------|----------|
| **Аккаунт Anthropic** | v0.1 | Регистрация в Anthropic Console |
| **API-ключ** | v0.1 | Получение и безопасное хранение API-ключа |
| **Лимиты и биллинг** | v0.1 | Настройка лимитов расходов и мониторинга |
| **Ограничение частоты** | v0.2 | Rate limiting на стороне ДЗ-чекера |
| **Fallback-модели** | v0.3 | Резервные модели (GPT-4o, Gemini) при недоступности |

### Инфраструктура

| Задача | Приоритет | Описание |
|--------|-----------|----------|
| **VPS-сервер** | v0.1 | Аренда VPS (Selectel/Timeweb) для размещения сервисов |
| **Docker Compose** | v0.1 | Конфигурация для запуска ДЗ-чекера + MCP-сервера |
| **HTTPS-сертификат** | v0.1 | Let's Encrypt для защищённого соединения с LMS |
| **Переменные окружения** | v0.1 | Безопасное хранение API-ключей через .env |
| **Мониторинг** | v0.2 | Prometheus + Grafana для отслеживания состояния |
| **CI/CD** | v0.2 | GitHub Actions для автоматического деплоя |
| **Резервное копирование** | v0.2 | Бэкапы конфигурации и логов |
| **Kubernetes** | v1.0 | Миграция на k8s для масштабирования |

---

## Интерфейс для студента (третий экран)

```
┌────────────────────────────────────────────────────────────┐
│  Результат ИИ-проверки                                     │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ✓ Принято (85/100)                    08.09.2025 в 20:35 │
│                                                            │
│  Сильные стороны:                                          │
│  • Верно указано, что любая модель фокусируется на        │
│    определённых свойствах                                  │
│  • Хороший пример с программным продуктом                  │
│                                                            │
│  Замечания:                                                │
│  • Не использован термин «описание системы» —              │
│    рекомендую использовать точную терминологию             │
│                                                            │
│  Следующий шаг:                                            │
│  Попробуйте привести ещё один пример из вашей практики    │
│                                                            │
│  ─────────────────────────────────────────────────────     │
│  Проверено: Claude 3.5 Sonnet                             │
│  По материалам: Глава 1, раздел 1.1                        │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

---

## Ключевые компоненты в репозитории руководств

### Карта вопросов

Связывает идентификаторы вопросов LMS с материалами:

- **Идентификатор вопроса** → путь к файлу руководства
- **Раздел руководства** → конкретный заголовок/якорь
- **Рубрика** → какой набор критериев применять
- **Ключевые слова** → для поиска и проверки

### Рубрики проверки

Критерии с весами для оценки:

- **Понимание концепции:**
  - Ключевая идея (40%)
  - Собственный пример (30%)
  - Терминология (20%)
  - Полнота (10%)

- **Глубокое понимание:**
  - Суть концепции (35%)
  - Аргументация (35%)
  - Связи с другими понятиями (20%)
  - Рефлексия (10%)

---

## Пороги автоматических решений

| Диапазон баллов | Действие |
|-----------------|----------|
| 80–100 | Автоматически принять |
| 60–79 | Отправить наставнику на проверку |
| 0–59 | Автоматически вернуть на доработку |

---

## Реализация

Код агента: `agents-core/homework-checker/`

```
agents-core/homework-checker/
├── README.md                 # Техническая документация
├── manifest.json             # Манифест агента
├── server.py                 # HTTP-сервер с endpoint
├── config.yaml               # Конфигурация
├── data/
│   ├── questions_map.yaml    # Карта вопросов
│   ├── rubrics.yaml          # Рубрики
│   └── prompts/              # Промпты для LLM
├── schemas/                  # Схемы данных
└── examples/                 # Примеры данных
```

---

## Roadmap

### v0.1 — Первый релиз (MVP)

**Ограничения:**
- Только задания типа «чеклист/ДЗ»
- Проверка инициируется студентом по каждому пункту чеклиста/ДЗ отдельно
- Доступно только студентам с действующей подпиской БР

**Процесс:**
1. Студент заполняет комментарий к заданию
2. Нажимает кнопку «Проверить с ИИ»
3. С фронта на endpoint ДЗ-чекера отправляется:
   - Текст заполненного ответа студента по выбранному пункту
   - Текст вопроса
   - Информация о разделе (отображаемый в дереве навигации текст раздела, без идентификаторов)
   - Информация о курсе (текстовое название курса, без идентификаторов и номеров версий)
4. ДЗ-чекер обрабатывает запрос, возвращает синхронно результат проверки (текст)
5. Студенту на фронте отображается текст результата

**Важно:** В v0.1 результат проверки нигде не сохраняется и потеряется при обновлении страницы или переходе на другие разделы курса.

**Технические задачи:**
- HTTP-endpoint для синхронной проверки
- Интеграция с репозиторием руководств
- Интеграция с Claude API
- Базовые промпты для проверки

### v0.2 — Интеграция и сохранение

- Сохранение результатов проверки в LMS
- Карта вопросов (связь идентификаторов с руководствами)
- Рубрики проверки по типам вопросов
- Логирование и мониторинг
- Статусы проверки в интерфейсе

### v0.3 — Улучшения

- Резервные модели LLM
- Кэширование контекста
- Обратная связь от наставников
- Пакетная обработка

### v1.0 — Production

- Полный API для LMS
- Панель мониторинга
- Поддержка нескольких курсов
- Аналитика качества проверок

---

## Открытые вопросы

1. ~~**Формат обмена с LMS** — webhook, REST API, или файловый обмен?~~ → v0.1: синхронный REST API
2. ~~**Архитектура ДЗ-чекера** — какие модули, на чём строить?~~ → v0.1: FastAPI + anthropic SDK
3. ~~**Какой LLM использовать** — Claude, GPT, локальный?~~ → v0.1: Claude 3.5 Sonnet (API)
4. **Хранение результатов** — в LMS, в репозитории, или в отдельной БД? → v0.2
5. **Роль наставника** — всегда проверяет после ИИ или только спорные случаи?
6. **Версионирование материалов** — как отслеживать, по какой версии руководства проверяли?
7. **n8n vs код** — использовать ли n8n для оркестрации или чистый Python? → Рекомендация: Python для v0.1

---

**Статус:** Концепция v0.1 (архитектура уточнена)
**Дата:** 2025-12-25
