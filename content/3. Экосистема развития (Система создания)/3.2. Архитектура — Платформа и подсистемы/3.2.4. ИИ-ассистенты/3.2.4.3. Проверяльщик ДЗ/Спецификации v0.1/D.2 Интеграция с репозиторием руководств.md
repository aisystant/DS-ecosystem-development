# D.2 Интеграция с репозиторием руководств

Спецификация взаимодействия ДЗ-чекера с репозиторием руководств для получения контекста проверки.

---

## Назначение

Репозиторий руководств предоставляет **нормативный контент** для проверки ответов:
- Тексты разделов руководств (норматив)
- Рубрики проверки (критерии с весами)

---

## Текущее состояние (v0.1)

### Заглушка httpbin

В v0.1 используется заглушка `https://httpbin.org/post`, которая просто возвращает переданные данные обратно.

**HTTP Request нода в n8n:**
```
URL: https://httpbin.org/post
Method: POST
Body: ={{ $json }}
```

Это означает, что в v0.1:
- `normative_text` не подставляется (используется placeholder)
- `rubric` не подставляется (критерии не переданы)

---

## Целевое состояние (v0.2)

### MCP endpoint

Репозиторий руководств будет реализован как **MCP-сервер** по аналогии с [fsm-mcp](https://github.com/aisystant/fsm-mcp).

**MCP-эндпоинт:**
```
https://guides-mcp.aisystant.workers.dev/mcp
```

### Запрос контекста

**Параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `course_name` | string | Название курса (текстовое) |
| `section_name` | string | Название раздела из дерева навигации |

**Пример:**
```json
{
  "course_name": "Системное мышление",
  "section_name": "Физический мир и ментальное пространство"
}
```

### Ответ

```json
{
  "course_name": "string",
  "section_name": "string",
  "section_path": "string",
  "normative_text": "string",
  "rubric": {
    "name": "string",
    "passing_score": "number",
    "criteria": [
      {
        "id": "string",
        "weight": "number",
        "description": "string"
      }
    ]
  },
  "version": "string"
}
```

| Поле | Тип | Описание |
|------|-----|----------|
| `normative_text` | string | Текст норматива (фрагмент руководства) |
| `rubric` | object | Рубрика проверки с критериями |
| `version` | string | Версия материалов (git tag или commit) |

**Пример:**
```json
{
  "course_name": "Системное мышление",
  "section_name": "Физический мир и ментальное пространство",
  "section_path": "systems-thinking/chapter-01.md#section-1-1",
  "normative_text": "Физический мир существует объективно, независимо от нашего восприятия. Однако мы можем описывать его разными способами, фокусируясь на разных свойствах...",
  "rubric": {
    "name": "Понимание концепции",
    "passing_score": 60,
    "criteria": [
      {
        "id": "main_idea",
        "weight": 40,
        "description": "Студент передал ключевую идею из материала"
      },
      {
        "id": "own_example",
        "weight": 30,
        "description": "Приведён собственный пример, иллюстрирующий понимание"
      }
    ]
  },
  "version": "v2.3.1"
}
```

---

## Как используется в workflow

### Code (Build Prompt) нода

После получения контекста, Code нода собирает промпт:

```javascript
const criteriaText = (data.rubric?.criteria || [])
  .map(c => `- ${c.id} (${c.weight}%): ${c.description || ""}`)
  .join("\n");

const prompt = [
  "## Вопрос домашнего задания",
  data.question_text || "(нет вопроса)",
  "",
  "## Ответ стажера",
  data.answer_text || "(нет ответа)",
  "",
  "## Норматив",
  data.normative_text || "(норматив не найден)",
  "",
  "## Критерии оценки",
  criteriaText || "(критерии не переданы)",
  "",
  "## Инструкция",
  "Проверь ответ стажера по указанным критериям..."
].join("\n");
```

---

## Миграция с заглушки на MCP

### Шаг 1: Создать MCP-сервер

По аналогии с [fsm-mcp](https://github.com/aisystant/fsm-mcp):
- Git-репозиторий с руководствами
- Cloudflare Workers для хостинга
- MCP tool `get_check_context`

### Шаг 2: Заменить HTTP Request ноду

Изменить в n8n:
```
URL: https://httpbin.org/post
↓
URL: https://guides-mcp.aisystant.workers.dev/check-context
```

### Шаг 3: Проверить формат ответа

Убедиться, что ответ MCP содержит:
- `normative_text` — текст для подстановки в промпт
- `rubric.criteria` — массив критериев

---

## Обработка ошибок

| Ситуация | Действие |
|----------|----------|
| Курс не найден | Вернуть ошибку, использовать placeholder |
| Раздел не найден | Использовать общий текст курса |
| MCP недоступен | Fallback на заглушку, логировать |

---

## Связанные документы

- [fsm-mcp](https://github.com/aisystant/fsm-mcp) — референсная реализация
- [Общее описание Проверяльщика ДЗ](../Общее%20описание%20Проверяльщика%20ДЗ%20(ДЗ-чекер)%203.2.md)
- [D.4 Рубрики проверки](./D.4%20Рубрики%20проверки.md)

---

**Версия:** 0.1
**Дата:** 2025-12-31
**Статус:** Используется заглушка httpbin, MCP endpoint в разработке
